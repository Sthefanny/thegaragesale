<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Sale Hudson e Sthefanny</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            height: 100%;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .card-img-top {
            height: 200px;
            object-fit: contain;
        }

        .modal-header {
            background-color: #8a2be2;
            color: white;
        }

        .btn-primary {
            background-color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-primary:hover {
            background-color: #4b0082;
            border-color: #4b0082;
        }

        .btn-primary:focus {
            background-color: #4b0082;
            border-color: #4b0082;
            box-shadow: 0 0 0 0.25rem rgba(138, 43, 226, 0.5);
        }

        .btn-primary:active {
            background-color: #4b0082 !important;
            border-color: #4b0082 !important;
        }

        .btn-primary:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-secondary {
            background-color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-secondary:hover {
            background-color: #4b0082;
            border-color: #4b0082;
        }

        .btn-secondary:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-success:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-telegram {
            background-color: #0088cc;
            border-color: #0088cc;
            color: white;
        }

        .btn-telegram:hover {
            background-color: #006699;
            border-color: #006699;
            color: white;
        }

        .btn-outline-primary {
            color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-outline-primary:hover {
            background-color: #8a2be2;
            border-color: #8a2be2;
            color: white;
        }

        .btn-outline-primary:disabled {
            color: #d8bfff;
            border-color: #d8bfff;
            background-color: transparent;
        }

        .btn-outline-primary:active {
            background-color: #4b0082 !important;
            border-color: #4b0082 !important;
            color: white !important;
        }

        .text-center {
            color: #343a40;
        }

        .text-primary {
            color: #8a2be2 !important;
        }

        .carousel-item img {
            height: 400px;
            object-fit: contain;
            cursor: zoom-in;
        }

        #imagemAmpliada {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(138, 43, 226, 0.9);
            z-index: 9999;
            cursor: zoom-out;
        }

        #imagemAmpliada img {
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .miniaturas {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .miniatura {
            width: 80px;
            height: 80px;
            object-fit: contain;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .miniatura.active {
            border-color: #8a2be2;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            filter: invert(19%) sepia(98%) saturate(5155%) hue-rotate(282deg) brightness(86%) contrast(112%);
            width: 3rem;
            height: 3rem;
        }

        .sub-item-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sub-item-count {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .card-img-grid {
            display: grid;
            gap: 5px;
            height: 200px;
            overflow: hidden;
        }

        .card-img-grid.grid-1 {
            grid-template-columns: 1fr;
        }

        .card-img-grid.grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .card-img-grid.grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .card-img-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .card-img-grid.grid-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .card-img-grid.grid-9 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .card-img-grid.grid-12 {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .card-img-grid img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .no-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            background-color: #f8f9fa;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            border: 1px dashed #dee2e6;
        }
    </style>
</head>

<body>
    <!-- Tela Inicial -->
    <div class="container my-5">
        <h1 class="text-center mb-4">Garage Sale Hudson e Sthefanny</h1>
        <p class="text-center mb-4">Estamos nos mudando para outro país e por isso estamos vendendo muitas coisas. Confira abaixo!</p>
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <input type="text" id="filtro-produtos" class="form-control" placeholder="Procure um produto...">
            </div>
            <div class="col-md-3 mb-3">
                <select id="filtro-categoria" class="form-select">
                    <option value="">Todas as Categorias</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="filtro-disponibilidade" class="form-select">
                    <option value="">Todos os Status</option>
                    <option value="true">Disponível</option>
                    <option value="false">Reservado</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="ordenacao" class="form-select">
                    <option value="">Ordenar por...</option>
                    <option value="alfabetica">Ordem Alfabética</option>
                    <option value="categoria">Categoria</option>
                </select>
            </div>
        </div>
        <div class="row" id="produtos-container">
            <!-- Os produtos serão carregados dinamicamente aqui -->
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" aria-labelledby="detalhesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesModalLabel">Detalhes do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="carouselExample" class="carousel slide mb-2" data-bs-ride="carousel">
                        <div class="carousel-inner" id="carousel-images">
                            <!-- As imagens serão carregadas dinamicamente aqui -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>

                    <div class="miniaturas mb-4" id="miniaturas-container">
                        <!-- As miniaturas serão carregadas dinamicamente aqui -->
                    </div>

                    <h2 id="detalhe-titulo" class="text-primary">Produto</h2>
                    <p><strong>Descrição:</strong> <span id="detalhe-descricao"></span></p>
                    <p><strong>Valor:</strong> R$ <span id="detalhe-valor"></span></p>
                    <p><strong>Quantidade:</strong> <span id="detalhe-quantidade"></span></p>
                    <p><strong>Disponibilidade:</strong> <span id="detalhe-disponibilidade"></span></p>
                    <p><strong>Data de Entrega:</strong> <span id="detalhe-data"></span></p>
                    <p><strong>Estado:</strong> <span id="detalhe-estado"></span></p>
                    <p><strong>Categoria:</strong> <span id="detalhe-categoria"></span></p>

                    <div class="sub-item-nav mb-3">
                        <button class="btn btn-outline-primary" id="prev-sub-item" style="display: none;">Anterior</button>
                        <span class="sub-item-count"></span>
                        <button class="btn btn-outline-primary" id="next-sub-item" style="display: none;">Próximo</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" id="detalhe-whatsapp" class="btn btn-success" onclick="abrirModalContato(); return false;">Contatar via Chat</a>
                    <!-- <a href="#" id="detalhe-whatsapp" class="btn btn-success" onclick="abrirModalContato(); return false;">Contatar via WhatsApp</a>
                    <a href="#" id="detalhe-telegram" class="btn btn-telegram" onclick="abrirModalTelegram(); return false;">Contatar via Telegram</a> -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Contato WhatsApp -->
    <div class="modal fade" id="contatoModal" tabindex="-1" aria-labelledby="contatoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contatoModalLabel">Informações de Contato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id='tawk_677547d4af5bfec1dbe57fa5'></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Contato Telegram -->
    <div class="modal fade" id="telegramModal" tabindex="-1" aria-labelledby="telegramModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="telegramModalLabel">Informações para Telegram</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="telegramForm">
                        <div class="mb-3">
                            <label for="nomeTelegram" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nomeTelegram" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-telegram" onclick="criarGrupoTelegram()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container para imagem ampliada -->
    <div id="imagemAmpliada">
        <img src="" alt="Imagem Ampliada">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="products.js"></script>
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
        var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
        Tawk_API.embedded = 'tawk_677547d4af5bfec1dbe57fa5'; // ID do seu widget
        (function () {
            var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
            s1.async = true;
            s1.src = 'https://embed.tawk.to/677547d4af5bfec1dbe57fa5/1igh947p7';
            s1.charset = 'UTF-8';
            s1.setAttribute('crossorigin', '*');
            s0.parentNode.insertBefore(s1, s0);
        })();
    </script>
    <!--End of Tawk.to Script-->
    <script>
        $(document).ready(function () {
            let currentSubItemIndex = 0;
            let currentSubItems = [];
            let currentProduto = null;

            function carregarCategorias() {
                const categorias = [...new Set(produtos.map(produto => produto.categoria))];
                const filtroCategoria = $("#filtro-categoria");
                categorias.forEach(categoria => {
                    filtroCategoria.append(`<option value="${categoria}">${categoria}</option>`);
                });
            }

            function carregarProdutos(filtroTexto = "", filtroCategoria = "", filtroDisponibilidade = "", ordenacao = "") {
                const container = $("#produtos-container");
                container.empty();

                let produtosFiltrados = produtos.filter(produto =>
                    produto.titulo.toLowerCase().includes(filtroTexto.toLowerCase()) &&
                    (filtroCategoria === "" || produto.categoria === filtroCategoria) &&
                    (filtroDisponibilidade === "" || produto.disponivel.toString() === filtroDisponibilidade)
                );

                if (ordenacao === "alfabetica") {
                    produtosFiltrados.sort((a, b) => a.titulo.localeCompare(b.titulo));
                } else if (ordenacao === "categoria") {
                    produtosFiltrados.sort((a, b) => a.categoria.localeCompare(b.categoria));
                }

                produtosFiltrados.forEach(produto => {
                    const subItems = produto.subItems || [];
                    let cardContent;

                    if (subItems.length > 0) {
                        if (subItems.some(item => item.imagens && item.imagens.length > 0)) {
                            const imagensGrid = subItems.map(item =>
                                item.imagens && item.imagens.length > 0
                                    ? `<img src="images/${item.imagens[0]}" alt="${item.titulo}">`
                                    : `<div class="no-image-placeholder">Em breve imagens</div>`
                            ).join('');
                            const gridClass = subItems.length <= 1 ? 'grid-1' :
                                subItems.length <= 2 ? 'grid-2' :
                                    subItems.length <= 3 ? 'grid-3' :
                                        subItems.length <= 4 ? 'grid-4' :
                                            subItems.length <= 6 ? 'grid-6' :
                                                subItems.length <= 9 ? 'grid-9' : 'grid-12';
                            cardContent = `<div class="card-img-grid ${gridClass}">${imagensGrid}</div>`;
                        } else {
                            cardContent = `<div class="no-image-placeholder">Em breve imagens</div>`;
                        }
                    } else {
                        if (produto.imagens && produto.imagens.length > 0) {
                            cardContent = `<img src="images/${produto.imagens[0]}" alt="${produto.titulo}" class="card-img-top">`;
                        } else {
                            cardContent = `<div class="no-image-placeholder">Em breve imagens</div>`;
                        }
                    }

                    container.append(`
                        <div class="col-md-4 mb-4">
                            <div class="card" onclick="verDetalhes(${produto.id})">
                                ${cardContent}
                                <div class="card-body">
                                    <h5 class="card-title">${produto.titulo}</h5>
                                    <p class="card-text">Categoria: ${produto.categoria}</p>
                                    ${subItems.length > 0 ? '' : `<p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}</p>`}
                                    <p class="card-text">Quantidade: ${subItems.length > 0 ? subItems.length + ' itens' : produto.quantidade}</p>
                                    <p class="card-text ${produto.disponivel ? 'text-success' : 'text-danger'}">
                                        ${produto.disponivel ? 'Disponível' : 'Reservado'}
                                    </p>
                                    <button class="btn btn-primary" onclick="verDetalhes(${produto.id})">Ver Detalhes</button>
                                </div>
                            </div>
                        </div>
                    `);
                });
            }

            $("#filtro-produtos, #filtro-categoria, #filtro-disponibilidade, #ordenacao").on("change input", function () {
                carregarProdutos(
                    $("#filtro-produtos").val(),
                    $("#filtro-categoria").val(),
                    $("#filtro-disponibilidade").val(),
                    $("#ordenacao").val()
                );
            });

            function atualizarNavegacaoSubItems() {
                if (currentSubItems.length > 1) {
                    $("#prev-sub-item").show();
                    $("#next-sub-item").show();
                    $(".sub-item-count").text(`${currentSubItemIndex + 1} de ${currentSubItems.length}`);
                } else {
                    $("#prev-sub-item").hide();
                    $("#next-sub-item").hide();
                    $(".sub-item-count").text('');
                }

                $("#prev-sub-item").prop('disabled', currentSubItemIndex === 0);
                $("#next-sub-item").prop('disabled', currentSubItemIndex === currentSubItems.length - 1);
            }

            $("#prev-sub-item").click(function () {
                if (currentSubItemIndex > 0) {
                    currentSubItemIndex--;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                }
            });

            $("#next-sub-item").click(function () {
                if (currentSubItemIndex < currentSubItems.length - 1) {
                    currentSubItemIndex++;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                }
            });

            function mostrarSubItem(item) {
                $("#detalhe-titulo").text(item.titulo);
                $("#detalhe-descricao").text(item.descricao);
                $("#detalhe-valor").text(item.valor.toFixed(2));
                $("#detalhe-disponibilidade").text(item.disponivel ? 'Disponível' : 'Reservado');
                $("#detalhe-quantidade").text(item.quantidade);
                $("#detalhe-data").text(item.dataEntrega);
                $("#detalhe-estado").text(item.estado);
                $("#detalhe-categoria").text(item.categoria);

                const carousel = $("#carousel-images");
                const miniaturas = $("#miniaturas-container");
                carousel.empty();
                miniaturas.empty();

                if (item.imagens && item.imagens.length > 0) {
                    item.imagens.forEach((imagem, index) => {
                        carousel.append(`
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="images/${imagem}" class="d-block w-100" alt="Foto ${index + 1}" onclick="ampliarImagem('images/${imagem}')">
                            </div>
                        `);

                        miniaturas.append(`
                            <img src="images/${imagem}" 
                                class="miniatura ${index === 0 ? 'active' : ''}" 
                                alt="Miniatura ${index + 1}"
                                onclick="mudarImagem(${index})"
                            >
                        `);
                    });
                } else {
                    carousel.append(`
                        <div class="carousel-item active">
                            <div class="no-image-placeholder">Em breve imagens</div>
                        </div>
                    `);
                }

                atualizarNavegacaoSubItems();
            }

            window.verDetalhes = function (id) {
                const produto = produtos.find(p => p.id === id);
                if (produto) {
                    currentProduto = produto;
                    currentSubItems = produto.subItems || [produto];
                    currentSubItemIndex = 0;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                    $("#detalhesModal").modal('show');
                }
            };

            function waitForTawkAPI(callback) {
                if (typeof Tawk_API !== "undefined") {
                    callback();
                } else {
                    console.log("Aguardando Tawk_API...");
                    setTimeout(() => waitForTawkAPI(callback), 500);
                }
            }

            function generateTawkHash(visitorId) {

                fetch(`https://garagesale-kappa.vercel.app/api/generate-hash?visitorId=${visitorId}`)
                    .then(response => response.json())
                    .then(data => {
                        const hash = data.hash;

                        if (typeof Tawk_API !== "undefined") {
                            Tawk_API.setAttributes({
                                name: "Nome do Visitante",
                                email: visitorId
                            }, function (error) {
                                if (error) {
                                    console.error("Erro ao definir atributos no Tawk.to:", error);
                                } else {
                                    console.log("Atributos definidos com sucesso!");
                                }
                            }, hash);
                        }
                    })
                    .catch(error => console.error("Erro ao gerar o hash:", error));
            }

            window.abrirModalContato = function () {
                const produto = currentSubItems[currentSubItemIndex];
                console.log("Abrindo modal de contato");

                const visitorId = "visitante@email.com"; // Substitua pelo ID do visitante
                let hash = generateTawkHash(visitorId);

                console.log("Hash gerado:", hash);

                waitForTawkAPI(() => {
                    console.log("Tawk_API carregado. Tentando definir atributos e adicionar tags...");

                    Tawk_API.setAttributes({
                        name: "Nome do Visitante",
                        email: visitorId,
                        titulo: produto.titulo,
                        valor: produto.valor.toFixed(2),
                        categoria: produto.categoria
                    }, function (error) {
                        if (error) {
                            console.error("Erro ao definir atributos no Tawk.to:", error);
                        } else {
                            console.log("Atributos definidos com sucesso!");
                        }
                    }, hash); // Passa o hash aqui

                    Tawk_API.addTags([produto.titulo], function (error) {
                        if (error) {
                            console.error("Erro ao adicionar tags no Tawk.to:", error);
                        } else {
                            console.log("Tags adicionadas com sucesso:", produto.titulo);
                        }
                    });
                });

                $("#detalhesModal").modal('hide');
                $("#contatoModal").modal('show');
            };



            window.abrirModalTelegram = function () {
                $("#detalhesModal").modal('hide');
                $("#telegramModal").modal('show');
            };

            window.criarGrupoTelegram = function () {
                const nome = $("#nomeTelegram").val();

                if (!nome) {
                    alert("Por favor, preencha seu nome.");
                    return;
                }

                const item = currentSubItems[currentSubItemIndex];
                const mensagem = `Olá! Gostaria de mais informações sobre o produto:\n\n` +
                    `Produto: ${item.titulo}\n` +
                    `Valor: R$ ${item.valor.toFixed(2)}\n` +
                    `Categoria: ${item.categoria}\n` +
                    `Estado: ${item.estado}\n\n` +
                    `Nome do interessado: ${nome}`;

                const numerosSellers = ["+5541999751101", "+5521986204744"];
                const nomeGrupo = `${item.titulo} - ${nome}`;

                // Como o Telegram não possui uma API web direta para criar grupos,
                // vamos redirecionar para uma conversa com o primeiro vendedor
                const urlTelegram = `https://t.me/${numerosSellers[0].replace(/\D/g, '')}`;

                $("#telegramModal").modal('hide');
                window.open(urlTelegram, '_blank');
            };

            window.mudarImagem = function (index) {
                $('#carouselExample').carousel(index);
                $('.miniatura').removeClass('active');
                $('.miniatura').eq(index).addClass('active');
            }

            $('#carouselExample').on('slide.bs.carousel', function (e) {
                $('.miniatura').removeClass('active');
                $('.miniatura').eq(e.to).addClass('active');
            });

            window.ampliarImagem = function (src) {
                const container = $("#imagemAmpliada");
                container.find("img").attr("src", src);
                container.show();
            }

            $("#imagemAmpliada").click(function () {
                $(this).hide();
            });

            carregarCategorias();
            carregarProdutos();
        });
    </script>
</body>

</html>